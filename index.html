<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.webmanifest">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lubrication Program - QA/QC Checklist</title>
  <style>
    :root{ --brand:#ff4d00; --ink:#222; --muted:#666; --bg:#f7f7f9; --line:#e6e6ef }
    *{ box-sizing:border-box }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--ink); margin:0; background:#f7f7f9
    }

    .page{ background:#fff; max-width:900px; margin:24px auto; padding:24px 28px;
      border:1px solid var(--line); border-radius:12px; box-shadow:0 4px 28px rgba(0,0,0,.05) }

    header{ display:grid; grid-template-columns:160px 1fr; gap:16px; align-items:center; margin-bottom:8px }
    header img{ max-width:160px; height:auto }
    .hdr-note{ text-align:right; font-size:12px; color:var(--muted) }
    .title{ font-size:22px; font-weight:700; margin:8px 0 16px }

    .meta{ display:grid; grid-template-columns:1fr 1fr; column-gap:32px; row-gap:10px }
    .row{ display:grid; grid-template-columns:160px 1fr; gap:6px; align-items:center }
    .row.wide{ grid-column:1/-1 }
    .lbl{ color:var(--brand); font-weight:700 }

    input[type="text"],input[type="date"],input[type="time"],textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff
    }

    .gate{ display:grid; grid-template-columns:20px 1fr; gap:10px; padding:10px 12px;
      border:1px dashed var(--line); border-radius:10px; background:#fff8f0; color:#7a4a00; margin-top:12px }

    .hidden{ display:none !important }
    .divider{ border-top:2px solid var(--line); margin:16px 0 24px }

    .q{ padding:20px 24px; border:1px solid var(--line); border-radius:10px; margin-bottom:14px; background:#fff }
    .q h4{ margin:0 0 8px; font-size:16px }
    .q .opts{ display:flex; gap:16px; margin:6px 0 }
    .q .followup{ margin-top:10px; display:none }
    .q textarea{ min-height:72px }

    .hint{ font-size:12px; color:var(--muted) }

    /* Bigger, centered preview thumbnails (keep as you liked) */
    .thumbs{
      display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; justify-content:center
    }
    .thumbs img{
      max-width:100%;
      width: min(420px, 95%);
      height:auto;
      border:1px solid var(--line); border-radius:8px
    }

    .ref-img{ width:100%; height:auto; border:1px solid var(--line); border-radius:8px }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }

    .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:20px; flex-wrap:wrap }
    button{
      border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:600;
      background:#ececf6; color:var(--ink); box-shadow:0 1px 0 rgba(0,0,0,.03);
      transition:filter .15s ease
    }
    button:hover{ filter:brightness(.97) }
    .btn-primary{ background:var(--brand); color:#fff }
    .btn-accent{ background:#1f7aec; color:#fff } /* "Print style" look */

    /* Autocomplete */
    .ac-wrap{ position:relative }
    .ac-input{ width:100%; padding:12px 40px 12px 12px; border:2px solid #111; border-radius:10px; background:#fff }
    .ac-chevron{ position:absolute; right:10px; top:0; height:100%; display:flex; align-items:center;
      background:transparent; border:0; padding:0 2px; cursor:pointer; color:#666 }
    .ac-chevron svg{ width:18px; height:18px }
    .ac-panel{
      position:absolute; top:calc(100% + 8px); left:50%; transform:translateX(-50%);
      width:min(880px, calc(100vw - 64px)); z-index:40; padding:8px; background:#1f1f1f; color:#fff;
      border:1px solid #0d0d0d; border-radius:12px; max-height:300px; overflow:auto; box-shadow:0 10px 28px rgba(0,0,0,.35)
    }
    .ac-item{ display:block; width:100%; text-align:left; border:none; background:transparent;
      padding:10px 12px; border-radius:8px; cursor:pointer; color:#fff; font-weight:600; line-height:1.25 }
    .ac-item:hover,.ac-item[aria-selected="true"]{ background:#2e2e2e }
    .ac-empty{ padding:10px 12px; color:#c7c7c7 }

    /* Equipment photo block */
    .asset-photo-wrap{ margin:6px 0 18px }
    .asset-photo-title{ font-weight:700; color:var(--brand); margin:0 0 6px }
    .asset-photo{ display:block; width:100%; height:auto; background:transparent; border:none; border-radius:0 }
    .asset-photo-hint{ font-size:12px; color:var(--muted); margin-top:6px }

    /* Entry block frame */
    .entry{ border:2px dashed var(--line); border-radius:12px; padding:12px 12px 2px; margin:18px 0 }
    .entry-title{ font-weight:800; color:#444; margin:0 0 6px }
    .entry-top{ display:grid; grid-template-columns:160px 1fr; gap:6px; align-items:center; margin-bottom:8px }
    .entry-top .lbl{ color:var(--brand) }

    /* MOBILE */
    @media (max-width: 640px){
      .meta{ grid-template-columns:1fr }
      .row{ grid-template-columns:1fr; gap:4px }
      header{ grid-template-columns:1fr; gap:8px }
      .hdr-note{ text-align:left }
      .grid2{ grid-template-columns:1fr }
      .entry-top{ grid-template-columns:1fr }
      .actions{ justify-content:stretch }
      .actions button{ width:100% }
    }

    @media print{
      body{ background:#fff }
      .page{ box-shadow:none; border:none; margin:0; max-width:none; border-radius:0 }
      .actions,.hdr-note,.gate{ display:none !important }
      input,textarea{ border:none }
    }
  </style>
</head>
<body>
  <div class="page" id="captureArea">
    <header>
      <img id="headerLogo" src="Images/Logo_ArcelorMittal.png" alt="ArcelorMittal">
      <div class="hdr-note">Consult the electronic version for the current information: printed – <span id="printedAt"></span></div>
    </header>

    <div class="title">Lubrication Program - QA/QC Checklist</div>

    <!-- Global meta -->
    <section class="meta">
      <div class="row">
        <div class="lbl">Business Unit:</div>
        <div><input type="text" id="business_unit" value="TIN PLATE PRODUCT"></div>
      </div>

      <div class="row">
        <div class="lbl">Department:</div>
        <div><input type="text" id="department" value="TIN MILL STREAM MAINTENANCE"></div>
      </div>

      <div class="row">
        <div class="lbl">Assigned WO#:</div>
        <div><input type="text" id="wo_number" placeholder="e.g., TIN-123456"></div>
      </div>

      <div class="row wide">
        <div class="lbl">Route ID:</div>
        <div class="ac-wrap">
          <input id="route_search" class="ac-input" placeholder="Type or paste a code (e.g., W3ELL0037)">
          <button class="ac-chevron" type="button" id="route_toggle" aria-label="Open list">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div id="route_panel" class="ac-panel hidden"></div>
          <div class="hint">Only specific “Technical Info” routes will unlock the checklist below.</div>
        </div>
      </div>
    </section>

    <div id="routeGate" class="gate">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2l10 18H2L12 2zM12 9v5M12 17h.01" stroke="#b45309" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>Select one Work Instruction / Route ID to proceed. For example: <strong>W3ELL0037</strong>.</div>
    </div>

    <!-- MULTI-ASSET ENTRIES -->
    <div id="formBody" class="hidden">
      <div class="divider"></div>
      <h3 class="entry-title">Equipment / Asset Entries</h3>
      <div id="assetEntries"></div>

      <div class="actions no-print" data-html2canvas-ignore="true" style="justify-content:flex-start">
        <button class="btn-primary" id="addEntryBtn">+ Add Asset Entry</button>
      </div>

      <div class="divider"></div>

      <section class="q">
        <h4>Execution</h4>
        <div class="grid2">
          <div>
            <label class="hint">Inspector / Technician Name</label>
            <input id="tech_name" type="text" placeholder="Your name">
          </div>
          <div>
            <label class="hint">Date &amp; Time</label>
            <div class="grid2">
              <input id="date_exec" type="date">
              <input id="time_exec" type="time">
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="actions no-print" data-html2canvas-ignore="true">
      <button class="btn-accent" id="printBtn">Print to PDF</button>
      <button class="btn-primary" id="submitBtn">Submit Form (attach PDF)</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
          integrity="sha512-YcsIPQx3X9bY2l6f0bB8C8sQ1z7d3h0gZqz0qj3S5tG1Gm9lB1JQ6oZKp8kq8W2Jq4m2hA6g4Qw1sP8a8g+K1A=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    document.getElementById('printedAt').textContent = new Date().toLocaleString();

    const RECIPIENT = 'jefferson.dossantos@arcelormittal.com';
    const allowedRouteCodes = ['W3ELL0037','W3ELL0038','W3ELL0039'];

    const routeLines = `
W3ELL0001 - ETL3-LUB- 6 WEEK ENTRY LUBRICATION PM
W3ELL0002 - ETL3-LUB- 6 WEEK EXIT LUBRICATION PM
W3ELL0003 - 3ETL-LUB- 6 WEEK OIL MIST/GEARBOX CHECKS CLEANER / PICKLE
W3ELL0037 - ETL3-LUB- PROCESS LUBRICATION TECHNICAL INFO
W3ELL0038 - ETL3-LUB- ENTRY SECTION LUBRICATION TECHNICAL INFO
W3ELL0039 - ETL3-LUB- EXIT SECTION LUBRICATION TECHNICAL INFO
`.trim().split('\n');

    const assetLines = `
BRU - 001 - MAIN.PROC.TFIN.ETL3.PROC.BRU2.ENTR.ROLL - Driven Side
BRU - 002 - MAIN.PROC.TFIN.ETL3.PROC.BRU2.ENTR.ROLL - OPS Side
BRU - 003 - MAIN.PROC.TFIN.ETL3.PROC.BRU2.MIDL.ROLL - Driven Side
DFR - 286 - DELFECTOR  ROLL ASSEMBLY E3A - OPS Side
`.trim().split('\n');

    // ---------- Generic Autocomplete ----------
    function buildAutocomplete(input, panel, toggle, data, onPick) {
      function render(filterText) {
        panel.innerHTML = '';
        const txt = (filterText || '').toLowerCase();
        const list = data.filter(line => line.toLowerCase().includes(txt));
        if (list.length === 0) {
          const div = document.createElement('div');
          div.className = 'ac-empty';
          div.textContent = 'No matches found.';
          panel.appendChild(div);
        } else {
          list.forEach(line => {
            const b = document.createElement('button');
            b.type = 'button';
            b.className = 'ac-item';
            b.textContent = line;
            b.addEventListener('click', () => { input.value = line; hide(); onPick && onPick(line); });
            panel.appendChild(b);
          });
        }
        show();
      }
      function show(){ panel.classList.remove('hidden'); }
      function hide(){ panel.classList.add('hidden'); }

      input.addEventListener('focus', () => render(input.value));
      toggle.addEventListener('click', () => {
        if (panel.classList.contains('hidden')) render(input.value); else hide();
      });
      input.addEventListener('input', () => render(input.value.trim()));
      input.addEventListener('blur', () => setTimeout(hide, 120));
      panel.addEventListener('mousedown', e => e.preventDefault());
    }

    // Route autocomplete (global)
    buildAutocomplete(
      document.getElementById('route_search'),
      document.getElementById('route_panel'),
      document.getElementById('route_toggle'),
      routeLines,
      (line)=>applyGateFromValue(line)
    );

    document.getElementById('route_search').addEventListener('change', e=>{
      const v = e.target.value.trim();
      const code = v.includes(' - ') ? v.split(' - ')[0] : v;
      const full = routeLines.find(l => l.startsWith(code + ' - '));
      if (full) e.target.value = full;
      applyGateFromValue(e.target.value);
    });

    function applyGateFromValue(routeFullText){
      const code = (routeFullText || '').split(' - ')[0];
      const ok = allowedRouteCodes.includes(code);
      document.getElementById('formBody').classList.toggle('hidden', !ok);
      document.getElementById('routeGate').classList.toggle('hidden', ok);
      if (ok && document.querySelectorAll('.entry').length === 0){
        addAssetEntry(); // ensure first entry exists
      }
    }

    // ---------- Entry factory ----------
    let entryCounter = 0;

    function addAssetEntry(){
      entryCounter++;
      const idx = entryCounter;
      const container = document.getElementById('assetEntries');

      const entry = document.createElement('div');
      entry.className = 'entry';
      entry.dataset.idx = idx;

      entry.innerHTML = `
        <div class="entry-top">
          <div class="lbl">Equipment / Asset ID:</div>
          <div class="ac-wrap">
            <input id="asset_search_${idx}" class="ac-input" placeholder="Type or paste an asset name…">
            <button class="ac-chevron" type="button" id="asset_toggle_${idx}" aria-label="Open list">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </button>
            <div id="asset_panel_${idx}" class="ac-panel hidden"></div>
          </div>
        </div>

        <div id="assetPhotoBlock_${idx}" class="asset-photo-wrap hidden">
          <p class="asset-photo-title">Inspection target</p>
          <img id="assetPhoto_${idx}" class="asset-photo" alt="Equipment / Asset reference image">
          <div id="assetPhotoHint_${idx}" class="asset-photo-hint"></div>
        </div>

        <section class="q" data-q="1">
          <h4>1 — Was the lubrication point lubricated as per WI standard?</h4>
          <div class="opts">
            <label><input type="radio" name="q1_${idx}" value="Yes"> Yes</label>
            <label><input type="radio" name="q1_${idx}" value="No"> No</label>
          </div>
          <div class="followup">
            <div class="hint">Please, provide more information and upload a picture.</div>
            <textarea id="q1_txt_${idx}" placeholder="Describe the deviation..."></textarea>
            <input type="file" id="q1_img_${idx}" accept="image/*" multiple />
            <div class="thumbs" id="q1_thumbs_${idx}"></div>
          </div>
        </section>

        <section class="q" data-q="1b">
          <h4>1B — Amount of lubricant inserted/filled</h4>
          <div class="grid2" style="align-items:end;">
            <div>
              <label class="hint" for="amt_value_${idx}">Amount</label>
              <input id="amt_value_${idx}" class="num-input" type="number" inputmode="decimal" min="0" step="0.001" placeholder="0.000">
            </div>
            <div>
              <label class="hint">Units</label>
              <div class="inline-opts">
                <label><input type="radio" name="amt_unit_${idx}" value="g" checked> Grams (g)</label>
                <label><input type="radio" name="amt_unit_${idx}" value="L"> Liter (L)</label>
              </div>
            </div>
          </div>
          <div class="hint">Enter numbers only (decimals allowed). Leave blank if not applicable.</div>
        </section>

        <section class="q" data-q="2">
          <h4>2 — Was there any inconsistency with the volume added/purged to the pillow block/bearing?</h4>
          <div class="opts">
            <label><input type="radio" name="q2_${idx}" value="Yes"> Yes</label>
            <label><input type="radio" name="q2_${idx}" value="No"> No</label>
          </div>
          <div class="followup">
            <div class="hint">Please, provide more information and upload a picture.</div>
            <textarea id="q2_txt_${idx}" placeholder="Explain the volume discrepancy..."></textarea>
            <input type="file" id="q2_img_${idx}" accept="image/*" multiple />
            <div class="thumbs" id="q2_thumbs_${idx}"></div>
          </div>
        </section>

        <section class="q" data-q="3">
          <h4>3 — Are the hoses, grease nipples, and other lubricant components in good condition?</h4>
          <div class="opts">
            <label><input type="radio" name="q3_${idx}" value="Yes"> Yes</label>
            <label><input type="radio" name="q3_${idx}" value="No"> No</label>
          </div>
          <div class="followup">
            <div class="hint">Please, provide more information and upload a picture.</div>
            <textarea id="q3_txt_${idx}" placeholder="Describe damaged components..."></textarea>
            <input type="file" id="q3_img_${idx}" accept="image/*" multiple />
            <div class="thumbs" id="q3_thumbs_${idx}"></div>
          </div>
        </section>

        <section class="q" data-q="4">
          <h4>4 — Is there any sign of damage, malfunction, and/or leakage in the lubrication point indicated in the WI?</h4>
          <div class="opts">
            <label><input type="radio" name="q4_${idx}" value="Yes"> Yes</label>
            <label><input type="radio" name="q4_${idx}" value="No"> No</label>
          </div>
          <div class="followup">
            <div class="hint">Please, provide more information and upload a picture.</div>
            <textarea id="q4_txt_${idx}" placeholder="Describe the observation..."></textarea>
            <input id="q4_img_${idx}" type="file" accept="image/*" multiple />
            <div class="thumbs" id="q4_thumbs_${idx}"></div>
          </div>
        </section>

        <section class="q" data-q="5">
          <h4>5 — Was the purged grease hardened or visually degraded compared to new grease?</h4>
          <div class="hint">Use the reference strip below for examples (oil separation, hardening, contamination, starvation, thermal degradation).</div>
          <img class="ref-img" src="Images/Grease-Evaluation_Chart.png" alt="Grease Degradation Reference" />
          <div class="opts" style="margin-top:8px;">
            <label><input type="radio" name="q5_${idx}" value="Yes"> Yes</label>
            <label><input type="radio" name="q5_${idx}" value="No"> No</label>
          </div>
          <div class="followup">
            <div class="hint">Please, provide more information and upload a picture.</div>
            <textarea id="q5_txt_${idx}" placeholder="Describe grease condition..."></textarea>
            <input id="q5_img_${idx}" type="file" accept="image/*" multiple />
            <div class="thumbs" id="q5_thumbs_${idx}"></div>
          </div>
        </section>

        <section class="q" data-q="6">
          <h4>6 — Is the lubrication ID label present and legible (correct grease/oil spec)?</h4>
          <div class="opts">
            <label><input type="radio" name="q6_${idx}" value="Yes"> Yes</label>
            <label><input type="radio" name="q6_${idx}" value="No"> No</label>
          </div>
          <div class="followup">
            <textarea id="q6_txt_${idx}" placeholder="Label issues..."></textarea>
            <input id="q6_img_${idx}" type="file" accept="image/*" multiple />
            <div class="thumbs" id="q6_thumbs_${idx}"></div>
          </div>
        </section>

        <section class="q" data-q="7">
          <h4>7 — Guards in place; access safe; purge path clear?</h4>
          <div class="opts">
            <label><input type="radio" name="q7_${idx}" value="Yes"> Yes</label>
            <label><input type="radio" name="q7_${idx}" value="No"> No</label>
          </div>
          <div class="followup">
            <textarea id="q7_txt_${idx}" placeholder="Safety/access concerns..."></textarea>
            <input id="q7_img_${idx}" type="file" accept="image/*" multiple />
            <div class="thumbs" id="q7_thumbs_${idx}"></div>
          </div>
        </section>

        <section class="q" data-q="8">
          <h4>8 — Additional comments</h4>
          <textarea id="comments_${idx}" placeholder="Anything else noteworthy..."></textarea>
        </section>
      `;

      container.appendChild(entry);

      // Wire up the dynamic parts for this entry
      const assetInput  = entry.querySelector(`#asset_search_${idx}`);
      const assetPanel  = entry.querySelector(`#asset_panel_${idx}`);
      const assetToggle = entry.querySelector(`#asset_toggle_${idx}`);
      buildAutocomplete(assetInput, assetPanel, assetToggle, assetLines, (line)=>updateAssetPhotoFor(entry, line));

      assetInput.addEventListener('change', ()=>{
        const v = assetInput.value.trim();
        const exact = assetLines.find(d => d.toLowerCase() === v.toLowerCase());
        updateAssetPhotoFor(entry, exact || '');
      });

      // Image previews for this entry
      ['1','2','3','4','5','6','7'].forEach(n=>{
        const file = entry.querySelector(`#q${n}_img_${idx}`);
        const thumbs = entry.querySelector(`#q${n}_thumbs_${idx}`);
        if (!file || !thumbs) return;
        file.addEventListener('change', ()=>{
          thumbs.innerHTML = '';
          Array.from(file.files || []).forEach(f=>{
            const reader = new FileReader();
            reader.onload = ev => {
              const img = document.createElement('img');
              img.src = ev.target.result;
              thumbs.appendChild(img);
            };
            reader.readAsDataURL(f);
          });
        });
      });

      // Follow-up revealers (within this entry)
      function wireQuestion(localName, showOnValue){
        const radios = entry.querySelectorAll(`input[name="${localName}_${idx}"]`);
        const sec = radios.length ? radios[0].closest('.q') : null;
        const follow = sec ? sec.querySelector('.followup') : null;
        radios.forEach(r => r.addEventListener('change', ()=>{
          if (!follow) return;
          if (r.checked && r.value === showOnValue) follow.style.display = 'block';
          else if (r.checked) follow.style.display = 'none';
        }));
      }
      wireQuestion('q1', 'No');
      wireQuestion('q2', 'Yes');
      wireQuestion('q3', 'No');
      wireQuestion('q4', 'Yes');
      wireQuestion('q5', 'Yes');
      wireQuestion('q6', 'No');
      wireQuestion('q7', 'No');

      // Numeric guard for 1B
      const amt = entry.querySelector(`#amt_value_${idx}`);
      if (amt){
        amt.addEventListener('input', ()=>{
          let v = amt.value.replace(/[^0-9.]/g,'');
          const dot = v.indexOf('.');
          if (dot !== -1) v = v.slice(0, dot+1) + v.slice(dot+1).replace(/\./g,'');
          amt.value = v;
        });
      }
    }

    function updateAssetPhotoFor(entry, assetText){
      const block = entry.querySelector(`[id^="assetPhotoBlock_"]`);
      const img   = entry.querySelector(`[id^="assetPhoto_"]`);
      const hint  = entry.querySelector(`[id^="assetPhotoHint_"]`);
      if (!assetText){
        block.classList.add('hidden'); img.removeAttribute('src'); hint.textContent = ''; return;
      }
      const url = 'Images/' + encodeURIComponent(assetText) + '.png';
      img.onload = ()=>{ hint.textContent = assetText; block.classList.remove('hidden'); };
      img.onerror = ()=>{ block.classList.add('hidden'); hint.textContent=''; img.removeAttribute('src'); };
      img.src = url;
    }

    document.getElementById('addEntryBtn').addEventListener('click', addAssetEntry);

    // ----------------- Validation across ALL entries -----------------
    function ensureWoOrAlert() {
      const woEl = document.getElementById('wo_number');
      const wo = (woEl.value || '').trim();
      if (!wo) { alert('Please, enter Assigned WO#.'); woEl.focus(); return null; }
      return wo;
    }

    function validateAllEntries(){
      const entries = Array.from(document.querySelectorAll('.entry'));
      if (entries.length === 0){ alert('Please add at least one Asset Entry.'); return false; }

      for (const entry of entries){
        const idx = entry.dataset.idx;

        // Q1–Q7
        for (let i=1;i<=7;i++){
          const radios = entry.querySelectorAll(`input[name="q${i}_${idx}"]`);
          const any = Array.from(radios).some(r=>r.checked);
          if (!any){
            alert(`Please answer question ${i} for one of the asset entries.`);
            entry.scrollIntoView({behavior:'smooth', block:'center'}); return false;
          }
        }
        // 1B (if Q1 Yes then value required)
        const q1 = entry.querySelector(`input[name="q1_${idx}"]:checked`)?.value || '';
        const amtVal = (entry.querySelector(`#amt_value_${idx}`)?.value || '').trim();
        if (q1 === 'Yes' && !amtVal){
          alert('Please enter the amount for question 1B.');
          entry.querySelector(`#amt_value_${idx}`).focus();
          entry.scrollIntoView({behavior:'smooth', block:'center'}); return false;
        }
        // Q8 comments
        const comments = entry.querySelector(`#comments_${idx}`);
        if (!comments.value.trim()){
          alert('Please provide a comment in question 8 (Additional comments).');
          comments.scrollIntoView({behavior:'smooth', block:'center'}); return false;
        }
      }
      return true;
    }

    // ----------------- Email body + subject from ALL entries -----------------
    function buildStatusAndBody() {
      const entries = Array.from(document.querySelectorAll('.entry'));
      const redItems = [];
      const sections = [];

      entries.forEach(entry=>{
        const idx = entry.dataset.idx;
        const asset = entry.querySelector(`#asset_search_${idx}`)?.value || '—';

        const q = n => entry.querySelector(`input[name="q${n}_${idx}"]:checked`)?.value || '';
        if (q(1)==='No') redItems.push(`Asset [${asset}] — Q1 issue.`);
        if (q(2)==='Yes') redItems.push(`Asset [${asset}] — Q2 volume inconsistency.`);
        if (q(3)==='No') redItems.push(`Asset [${asset}] — Q3 component condition issue.`);
        if (q(4)==='Yes') redItems.push(`Asset [${asset}] — Q4 damage/leakage.`);
        if (q(5)==='Yes') redItems.push(`Asset [${asset}] — Q5 grease degraded.`);
        if (q(6)==='No') redItems.push(`Asset [${asset}] — Q6 label issue.`);
        if (q(7)==='No') redItems.push(`Asset [${asset}] — Q7 safety/access issue.`);

        const amtVal = (entry.querySelector(`#amt_value_${idx}`)?.value || '').trim();
        const amtUnitRaw = entry.querySelector(`input[name="amt_unit_${idx}"]:checked`)?.value || 'g';
        const amtUnit = amtUnitRaw === 'L' ? 'L' : 'g';

        sections.push(
`Asset: ${asset}
Q1:${q(1)}  Q2:${q(2)}  Q3:${q(3)}  Q4:${q(4)}  Q5:${q(5)}  Q6:${q(6)}  Q7:${q(7)}
Amount (1B): ${amtVal ? amtVal + ' ' + (amtUnit==='g'?'grams':'L') : '—'}
Comments: ${(entry.querySelector('#comments_'+idx)?.value || '')}`
        );
      });

      const isGreen = redItems.length === 0;
      const headerLine = isGreen
        ? 'QA/QC Performed with no issues identified. GREEN STATUS'
        : 'QA/QC Performed. RED STATUS — See items below and PDF:';

      const bodyLines = [
        headerLine,'',
        `Business Unit: ${document.getElementById('business_unit').value}`,
        `Department: ${document.getElementById('department').value}`,
        `WO#: ${document.getElementById('wo_number').value || '—'}`,
        `Route: ${document.getElementById('route_search').value || '—'}`,
        '',
        ...sections.map((s, i)=>`--- Asset Entry ${i+1} ---\n${s}`),
        '',
        `Tech: ${document.getElementById('tech_name').value || ''}  Date: ${document.getElementById('date_exec').value || ''} ${document.getElementById('time_exec').value || ''}`
      ];

      return { isGreen, bodyText: bodyLines.join('\n') };
    }

    function buildSubject() {
      const wo = document.getElementById('wo_number').value || 'TIN-XXXXX';
      const { isGreen } = buildStatusAndBody();
      const statusText = isGreen ? 'Green Status' : 'Red Status';
      return `QA/QC Execution Report - WO# ${wo} - ${statusText}`;
    }

    // ----------------- PDF helpers -----------------
    function pdfOptions(filename){
      return {
        margin:[10,10,10,10],
        filename,
        image:{ type:'jpeg', quality:0.98 },
        html2canvas:{ scale:2, useCORS:true, scrollY:0 },
        jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
      };
    }

    function getPdfFilename(){
      const wo = document.getElementById('wo_number').value || 'TIN-XXXXX';
      const routeCode = (document.getElementById('route_search').value || '').split(' - ')[0] || 'NoRoute';
      const { isGreen } = buildStatusAndBody();
      const statusShort = isGreen ? 'GREEN' : 'RED';
      return `QAQC_${wo}_${routeCode}_${statusShort}.pdf`;
    }

    async function generatePdfBlob(){
      const toHide = document.querySelectorAll('.ac-panel, .ac-chevron');
      toHide.forEach(el => el.classList.add('hidden'));
      const element = document.getElementById('captureArea');
      const filename = getPdfFilename();
      const opt = pdfOptions(filename);

      const blob = await html2pdf().from(element).set(opt).outputPdf('blob');
      toHide.forEach(el => el.classList.remove('hidden'));
      return { blob, filename };
    }

    function downloadPDF(){
      const element = document.getElementById('captureArea');
      const filename = getPdfFilename();
      const opt = pdfOptions(filename);
      const toHide = document.querySelectorAll('.ac-panel, .ac-chevron');
      toHide.forEach(el => el.classList.add('hidden'));
      html2pdf().from(element).set(opt).save().finally(()=>{
        toHide.forEach(el => el.classList.remove('hidden'));
      });
    }

    // ----------------- Submit / Print -----------------
    async function submitThenPdf() {
      if (!ensureWoOrAlert()) return;
      if (!validateAllEntries()) return;

      const subject = buildSubject();
      const { bodyText } = buildStatusAndBody();

      try {
        const { blob, filename } = await generatePdfBlob();
        const file = new File([blob], filename, { type: 'application/pdf' });

        if (navigator.canShare && navigator.canShare({ files:[file] })) {
          await navigator.share({ files:[file], title:subject, text:bodyText });
        } else {
          // Fallback: download + mailto (no attachment)
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          document.body.appendChild(a); a.click();
          URL.revokeObjectURL(a.href); a.remove();
          const mailto = `mailto:${encodeURIComponent(RECIPIENT)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;
          window.location.href = mailto;
        }
      } catch (err) {
        alert('Could not generate PDF. You can still try printing the page to PDF.');
        console.error(err);
      }
    }

    function printPdfClicked(){
      if (!ensureWoOrAlert()) return;
      if (!validateAllEntries()) return;
      downloadPDF();
    }

    // Wire buttons
    document.getElementById('submitBtn').addEventListener('click', submitThenPdf);
    document.getElementById('printBtn').addEventListener('click', printPdfClicked);

    // PWA SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .catch(err => console.error('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
