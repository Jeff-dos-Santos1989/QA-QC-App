<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.webmanifest">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Lubrication Program - QA/QC Checklist</title>

<style>
  :root{
    --brand:#ff4d00;
    --danger:#d92b2b;
    --ink:#222;
    --muted:#666;
    --bg:#f7f7f9;
    --line:#e6e6ef;
    --ok:#16a34a;
  }

  *{ box-sizing:border-box }
  body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);margin:0;background:#f7f7f9 }
  .page{ background:#fff;max-width:900px;margin:24px auto;padding:24px 28px;border:1px solid var(--line);border-radius:12px;box-shadow:0 4px 28px rgba(0,0,0,.05) }

  header{ display:grid;grid-template-columns:160px 1fr;gap:16px;align-items:center;margin-bottom:8px }
  header img{ max-width:160px;height:auto }
  .hdr-note{ text-align:right;font-size:12px;color:var(--muted) }
  .title{ font-size:22px;font-weight:700;margin:8px 0 16px }

  .meta{ display:grid;grid-template-columns:1fr 1fr;column-gap:32px;row-gap:10px }
  .row{ display:grid;grid-template-columns:160px 1fr;gap:6px;align-items:center }
  .row.wide{ grid-column:1/-1 }
  .lbl{ color:var(--brand);font-weight:700 }

  input[type="text"],input[type="date"],input[type="time"],textarea,
  /* include default-type inputs for styling too */
  input:not([type]){
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff
  }
  input[type="radio"],input[type="checkbox"]{ accent-color:var(--brand) }

  .gate{ display:grid;grid-template-columns:20px 1fr;gap:10px;padding:10px 12px;border:1px dashed var(--line);border-radius:10px;background:#fff8f0;color:#7a4a00;margin-top:12px }
  .hidden{ display:none !important }
  .divider{ border-top:2px solid var(--line);margin:16px 0 24px }

  .q{ padding:20px 24px;border:1px solid var(--line);border-radius:10px;margin-bottom:14px;background:#fff }
  .q h4{ margin:0 0 8px;font-size:16px }
  .q .opts{ display:flex;gap:16px;margin:6px 0 }
  .q .followup{ margin-top:10px;display:none }
  .q textarea{ min-height:72px }
  .hint{ font-size:12px;color:var(--muted) }

  .thumbs{ display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;justify-content:center }
  .thumbs img{ max-width:480px;width:min(100%,480px);height:auto;border:1px solid var(--line);border-radius:6px;display:block }
  .ref-img{ width:100%;height:auto;border:1px solid var(--line);border-radius:8px }

  .grid2{ display:grid;grid-template-columns:1fr 1fr;gap:12px }

  .actions{ display:flex;gap:12px;justify-content:flex-end;margin-top:20px }
  button{ border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600 }
  .btn-primary,.btn-secondary,.btn-add,.btn-submit,.btn-clear,.btn-print{ background:var(--brand);color:#fff }
  .btn-danger{ background:var(--danger);color:#fff }

  .ac-wrap{ position:relative }
  .ac-input{ width:100%;padding:12px 40px 12px 12px;border:2px solid #111;border-radius:10px;background:#fff }
  .ac-chevron{ position:absolute;right:10px;top:0;height:100%;display:flex;align-items:center;background:transparent;border:0;padding:0 2px;cursor:pointer;color:#666 }
  .ac-chevron svg{ width:18px;height:18px }
  .ac-panel{ position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);width:min(880px, calc(100vw - 64px));z-index:40;padding:8px;background:#1f1f1f;color:#fff;border:1px solid #0d0d0d;border-radius:12px;max-height:300px;overflow:auto;box-shadow:0 10px 28px rgba(0,0,0,.35) }
  .ac-item{ display:block;width:100%;text-align:left;border:none;background:transparent;padding:10px 12px;border-radius:8px;cursor:pointer;color:#fff;font-weight:600;line-height:1.25 }
  .ac-item:hover,.ac-item[aria-selected="true"]{ background:#2e2e2e }
  .ac-empty{ padding:10px 12px;color:#c7c7c7 }

  .inline-opts{ display:flex;gap:16px;align-items:center }
  .num-input{ width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px }

  .asset-photo-wrap{ margin:6px 0 18px }
  .asset-photo-title{ font-weight:700;color:var(--brand);margin:0 0 6px }
  .asset-photo{ display:block;width:100%;height:auto;background:transparent;border:none;border-radius:0 }
  .asset-photo-hint{ font-size:12px;color:var(--muted);margin-top:6px }

  .entry-controls{ display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:24px }

  /* printable marks for radios */
  .rb-mark{ font-weight:600;margin-right:16px }
  .rb-sel{ color:var(--brand) }
  .rb-unsel{ color:#888 }

  /* printable clones for inputs */
  .input-print{
    display:inline-block;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink);white-space:pre-wrap;min-height:38px;
  }

  /* success toast */
  .toast{ position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:10px;box-shadow:0 10px 30px rgba(0,0,0,.12);opacity:0;pointer-events:none;transition:.25s ease;z-index:9999 }
  .toast.show{ opacity:1;transform:translateX(-50%) translateY(0) }
  .toast .chk{ width:22px;height:22px;display:grid;place-items:center;border-radius:999px;background:var(--ok);color:#fff;font-weight:800 }

  @media (max-width:640px){
    .meta{ grid-template-columns:1fr }
    .row{ grid-template-columns:1fr;gap:4px }
    header{ grid-template-columns:1fr;gap:8px }
    .hdr-note{ text-align:left }
    .grid2{ grid-template-columns:1fr }
    .actions{ justify-content:stretch }
    .actions button{ width:100% }
    .entry-controls{ justify-content:stretch }
    .entry-controls button{ width:100% }
  }

  @media print{
    body{ background:#fff }
    .page{ box-shadow:none;border:none;margin:0;max-width:none;border-radius:0 }
    .actions,.hdr-note,.gate,.entry-controls{ display:none !important }
    input:not([type="radio"]):not([type="checkbox"]), textarea{
      border:none !important;background:#fff !important;color:#222 !important;
      box-shadow:none !important;-webkit-appearance:none;appearance:none;
    }
  }
</style>
</head>
<body>
  
  <div class="page" id="captureArea">
    <header>
      <img id="headerLogo" src="Images/Logo_ArcelorMittal.png" alt="ArcelorMittal">
      <div class="hdr-note">Consult the electronic version for the current information: printed ‚Äì <span id="printedAt"></span></div>
    </header>

    <div class="title">Lubrication Program - QA/QC Checklist</div>

    <section class="meta">
      <div class="row">
        <div class="lbl">Business Unit:</div>
        <div><input id="business_unit" value="TIN PLATE PRODUCT"></div>
      </div>

      <div class="row">
        <div class="lbl">Department:</div>
        <div><input id="department" value="TIN MILL STREAM MAINTENANCE"></div>
      </div>

      <div class="row">
        <div class="lbl">Assigned WO#:</div>
        <div><input type="text" id="wo_number" placeholder="e.g., TIN-123456"></div>
      </div>

      <div class="row wide">
        <div class="lbl">Route ID:</div>
        <div class="ac-wrap">
          <input id="route_search" class="ac-input" placeholder="Type or paste a code (e.g., W3ELL0037)">
          <button class="ac-chevron" type="button" id="route_toggle" aria-label="Open list">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div id="route_panel" class="ac-panel hidden"></div>
          <div class="hint">Only specific ‚ÄúTechnical Info‚Äù routes will unlock the checklist below.</div>
        </div>
      </div>
    </section>

    <div id="routeGate" class="gate">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2l10 18H2L12 2zM12 9v5M12 17h.01" stroke="#b45309" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>Select one Work Instruction / Route ID to proceed. For example: <strong>W3ELL0037</strong>.</div>
    </div>

    <div id="formBody" class="hidden">
      <div class="divider"></div>

      <div id="assetEntries"></div>

      <div class="divider"></div>
      <section class="q" id="execution">
        <h4>Execution</h4>

        <div class="row">
          <div class="lbl">Inspector / Technician Name</div>
          <div><input id="exec_name" placeholder="Your full name"></div>
        </div>

        <div class="row">
          <div class="lbl">Date &amp; Time</div>
          <div class="grid2">
            <input type="date" id="exec_date">
            <input type="time" id="exec_time">
          </div>
        </div>
      </section>
    </div>

    <div class="actions no-print" data-html2canvas-ignore="true">
      <button class="btn-clear"   id="clearBtn"  type="button">Clear Form</button>
      <button class="btn-submit"  id="submitBtn" type="button">Submit Form (Attach PDF)</button>
      <button class="btn-print"   id="printBtn"  type="button">Print to PDF</button>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="chk">‚úì</div>
    <div><strong>Form submitted</strong></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<script>
  document.getElementById('printedAt').textContent = new Date().toLocaleString();

  const RECIPIENT = 'jefferson.dossantos@arcelormittal.com';
  const allowedRouteCodes = ['W3ELL0037','W3ELL0038','W3ELL0039'];

  const routeLines = `
W3ELL0001 - ETL3-LUB- 6 WEEK ENTRY LUBRICATION PM
W3ELL0002 - ETL3-LUB- 6 WEEK EXIT LUBRICATION PM
W3ELL0003 - 3ETL-LUB- 6 WEEK OIL MIST/GEARBOX CHECKS CLEANER / PICKLE
W3ELL0037 - ETL3-LUB- PROCESS LUBRICATION TECHNICAL INFO
W3ELL0038 - ETL3-LUB- ENTRY SECTION LUBRICATION TECHNICAL INFO
W3ELL0039 - ETL3-LUB- EXIT SECTION LUBRICATION TECHNICAL INFO
`.trim().split('\n');

  const assetLines = `
BRU - 001 - MAIN.PROC.TFIN.ETL3.PROC.BRU2.ENTR.ROLL - Driven Side
BRU - 002 - MAIN.PROC.TFIN.ETL3.PROC.BRU2.ENTR.ROLL - OPS Side
BRU - 003 - MAIN.PROC.TFIN.ETL3.PROC.BRU2.MIDL.ROLL - Driven Side
DFR - 286 - DELFECTOR  ROLL ASSEMBLY E3A - OPS Side
`.trim().split('\n');

  /* ---------- Autocomplete ---------- */
  function buildAutocomplete({inputId, panelId, toggleId, data, onPick}) {
    const input = document.getElementById(inputId);
    const panel = document.getElementById(panelId);
    const toggle = document.getElementById(toggleId);

    function render(filterText) {
      panel.innerHTML = '';
      const txt = (filterText || '').toLowerCase();
      const list = data.filter(line => line.toLowerCase().includes(txt));
      if (list.length === 0) {
        const div = document.createElement('div');
        div.className = 'ac-empty';
        div.textContent = 'No matches found.';
        panel.appendChild(div);
      } else {
        list.forEach(line => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'ac-item';
          b.textContent = line;
          b.addEventListener('click', () => { input.value = line; hide(); onPick && onPick(line); });
          panel.appendChild(b);
        });
      }
      show();
    }
    function show(){ panel.classList.remove('hidden'); }
    function hide(){ panel.classList.add('hidden'); }

    input.addEventListener('focus', () => render(input.value));
    toggle.addEventListener('click', () => {
      if (panel.classList.contains('hidden')) render(input.value); else hide();
    });
    input.addEventListener('input', () => render(input.value.trim()));
    input.addEventListener('blur', () => setTimeout(hide, 120));
    panel.addEventListener('mousedown', e => e.preventDefault());
  }

  function applyGateFromValue(routeFullText){
    const code = (routeFullText || '').split(' - ')[0];
    const ok = allowedRouteCodes.includes(code);
    document.getElementById('formBody').classList.toggle('hidden', !ok);
    document.getElementById('routeGate').classList.toggle('hidden', ok);
    if (ok && document.querySelectorAll('.asset-entry').length === 0) addAssetEntry();
  }

  buildAutocomplete({
    inputId:'route_search', panelId:'route_panel', toggleId:'route_toggle', data:routeLines,
    onPick:(line)=>applyGateFromValue(line)
  });

  document.getElementById('route_search').addEventListener('change', e=>{
    const v = e.target.value.trim();
    const code = v.includes(' - ') ? v.split(' - ')[0] : v;
    const full = routeLines.find(l => l.startsWith(code + ' - '));
    if (full) e.target.value = full;
    applyGateFromValue(e.target.value);
  });

  function updateAssetPhotoIn(scope, assetName) {
    const wrap = scope.querySelector('.asset-photo-wrap');
    const img  = scope.querySelector('.asset-photo');
    const hint = scope.querySelector('.asset-photo-hint');
    if (!wrap || !img || !hint) return;
    if (!assetName) { wrap.classList.add('hidden'); img.src=''; hint.textContent=''; return; }
    const imgPath = `Images/${assetName}.png`;
    img.onload  = () => wrap.classList.remove('hidden');
    img.onerror = () => { wrap.classList.add('hidden'); console.warn('Image not found:', imgPath); };
    img.src = imgPath;
    hint.textContent = assetName;
  }

  const assetEntries = document.getElementById('assetEntries');

  function wireEntryDynamicBehaviours(scope){
    ['1','2','3','4','5','6','7'].forEach(n => {
      const input = scope.querySelector(`#q${n}_img`);
      const thumbs = scope.querySelector(`#q${n}_thumbs`);
      if (!input || !thumbs) return;
      input.addEventListener('change', () => {
        thumbs.innerHTML = '';
        Array.from(input.files || []).forEach(file => {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const img = document.createElement('img');
            img.src = ev.target.result;
            thumbs.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });
    });

    function wireQuestion(qn, showOnValue) {
      const sec = scope.querySelector('section.q[data-q="' + qn + '"]');
      if (!sec) return;
      const follow = sec.querySelector('.followup');
      const radios = sec.querySelectorAll('input[type=radio]');
      radios.forEach(r => r.addEventListener('change', () => {
        if (r.checked && r.value === showOnValue) follow.style.display = 'block';
        else if (r.checked) follow.style.display = 'none';
      }));
    }
    wireQuestion('1','No'); wireQuestion('2','Yes'); wireQuestion('3','No');
    wireQuestion('4','Yes'); wireQuestion('5','Yes'); wireQuestion('6','No'); wireQuestion('7','No');

    const amtField = scope.querySelector('.amt_value');
    if (amtField){
      amtField.addEventListener('input', () => {
        let v = amtField.value.replace(/[^0-9.]/g,'');
        const dot = v.indexOf('.');
        if (dot !== -1) v = v.slice(0, dot+1) + v.slice(dot+1).replace(/\./g,'');
        amtField.value = v;
      });
    }

    const removeBtn = scope.querySelector('.btn-remove-entry');
    if (removeBtn){
      removeBtn.addEventListener('click', () => {
        const all = document.querySelectorAll('.asset-entry');
        if (all.length === 1) { alert('At least one asset entry is required.'); return; }
        scope.remove();
      });
    }

    const addBtn = scope.querySelector('.btn-add-entry');
    if (addBtn) addBtn.addEventListener('click', () => addAssetEntry());
  }

  function addAssetEntry(){
    const entry = document.createElement('div');
    entry.className = 'asset-entry';
    const eid = crypto.randomUUID();

    entry.innerHTML = `
      <section class="q" data-q="asset">
        <h4>Equipment / Asset ID</h4>
        <div class="ac-wrap">
          <input id="asset_search_${eid}" class="ac-input" placeholder="Type or paste an asset name‚Ä¶">
          <button class="ac-chevron" type="button" id="asset_toggle_${eid}" aria-label="Open list">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
          <div id="asset_panel_${eid}" class="ac-panel hidden"></div>
        </div>
        <div class="hint">Select the specific asset for this entry.</div>
      </section>

      <div class="asset-photo-wrap hidden">
        <p class="asset-photo-title">Inspection target</p>
        <img class="asset-photo" alt="Equipment / Asset reference image">
        <div class="asset-photo-hint"></div>
      </div>

      <section class="q" data-q="1">
        <h4>1 ‚Äî Was the lubrication point lubricated as per WI standard?</h4>
        <div class="opts">
          <label><input type="radio" name="q1_${eid}" value="Yes"> Yes</label>
          <label><input type="radio" name="q1_${eid}" value="No"> No</label>
        </div>
        <div class="followup">
          <div class="hint">Please, provide more information and upload a picture.</div>
          <textarea placeholder="Describe the deviation..."></textarea>
          <input type="file" id="q1_img" accept="image/*" multiple />
          <div class="thumbs" id="q1_thumbs"></div>
        </div>
      </section>

      <section class="q" data-q="1b">
        <h4>1B ‚Äî Amount of lubricant inserted/filled</h4>
        <div class="grid2" style="align-items:end;">
          <div>
            <label class="hint">Amount</label>
            <input class="num-input amt_value" type="number" inputmode="decimal" min="0" step="0.001" placeholder="0.000">
          </div>
          <div>
            <label class="hint">Units</label>
            <div class="inline-opts">
              <label><input type="radio" name="amt_unit_${eid}" value="g" checked> Grams (g)</label>
              <label><input type="radio" name="amt_unit_${eid}" value="L"> Liter (L)</label>
            </div>
          </div>
        </div>
        <div class="hint">Enter numbers only (decimals allowed). Leave blank if not applicable.</div>
      </section>

      <section class="q" data-q="2">
        <h4>2 ‚Äî Was there any inconsistency with the volume added/purged to the pillow block/bearing?</h4>
        <div class="opts">
          <label><input type="radio" name="q2_${eid}" value="Yes"> Yes</label>
          <label><input type="radio" name="q2_${eid}" value="No"> No</label>
        </div>
        <div class="followup">
          <div class="hint">Please, provide more information and upload a picture.</div>
          <textarea placeholder="Explain the volume discrepancy..."></textarea>
          <input type="file" id="q2_img" accept="image/*" multiple />
          <div class="thumbs" id="q2_thumbs"></div>
        </div>
      </section>

      <section class="q" data-q="3">
        <h4>3 ‚Äî Are the hoses, grease nipples, and other lubricant components in good condition?</h4>
        <div class="opts">
          <label><input type="radio" name="q3_${eid}" value="Yes"> Yes</label>
          <label><input type="radio" name="q3_${eid}" value="No"> No</label>
        </div>
        <div class="followup">
          <div class="hint">Please, provide more information and upload a picture.</div>
          <textarea placeholder="Describe damaged components..."></textarea>
          <input type="file" id="q3_img" accept="image/*" multiple />
          <div class="thumbs" id="q3_thumbs"></div>
        </div>
      </section>

      <section class="q" data-q="4">
        <h4>4 ‚Äî Is there any sign of damage, malfunction, and/or leakage in the lubrication point indicated in the WI?</h4>
        <div class="opts">
          <label><input type="radio" name="q4_${eid}" value="Yes"> Yes</label>
          <label><input type="radio" name="q4_${eid}" value="No"> No</label>
        </div>
        <div class="followup">
          <div class="hint">Please, provide more information and upload a picture.</div>
          <textarea placeholder="Describe the observation..."></textarea>
          <input id="q4_img" type="file" accept="image/*" multiple />
          <div class="thumbs" id="q4_thumbs"></div>
        </div>
      </section>

      <section class="q" data-q="5">
        <h4>5 ‚Äî Was the purged grease hardened or visually degraded compared to new grease?</h4>
        <div class="hint">Use the reference strip below for examples (oil separation, hardening, contamination, starvation, thermal degradation).</div>
        <img class="ref-img" src="Images/Grease-Evaluation_Chart.png" alt="Grease Degradation Reference" />
        <div class="opts" style="margin-top:8px;">
          <label><input type="radio" name="q5_${eid}" value="Yes"> Yes</label>
          <label><input type="radio" name="q5_${eid}" value="No"> No</label>
        </div>
        <div class="followup">
          <div class="hint">Please, provide more information and upload a picture.</div>
          <textarea placeholder="Describe grease condition..."></textarea>
          <input id="q5_img" type="file" accept="image/*" multiple />
          <div class="thumbs" id="q5_thumbs"></div>
        </div>
      </section>

      <section class="q" data-q="6">
        <h4>6 ‚Äî Is the lubrication ID label present and legible (correct grease/oil spec)?</h4>
        <div class="opts">
          <label><input type="radio" name="q6_${eid}" value="Yes"> Yes</label>
          <label><input type="radio" name="q6_${eid}" value="No"> No</label>
        </div>
        <div class="followup">
          <textarea placeholder="Label issues..."></textarea>
          <input id="q6_img" type="file" accept="image/*" multiple />
          <div class="thumbs" id="q6_thumbs"></div>
        </div>
      </section>

      <section class="q" data-q="7">
        <h4>7 ‚Äî Guards in place; access safe; purge path clear?</h4>
        <div class="opts">
          <label><input type="radio" name="q7_${eid}" value="Yes"> Yes</label>
          <label><input type="radio" name="q7_${eid}" value="No"> No</label>
        </div>
        <div class="followup">
          <textarea placeholder="Safety/access concerns..."></textarea>
          <input id="q7_img" type="file" accept="image/*" multiple />
          <div class="thumbs" id="q7_thumbs"></div>
        </div>
      </section>

      <section class="q" data-q="10">
        <h4>8 ‚Äî Additional comments</h4>
        <textarea class="entry-comments" placeholder="Anything else noteworthy..."></textarea>
      </section>

      <div class="entry-controls no-print" data-html2canvas-ignore="true">
        <button type="button" class="btn-danger btn-remove-entry">Remove Asset Entry</button>
        <button type="button" class="btn-add btn-add-entry">Add Asset Entry</button>
      </div>

      <div class="divider"></div>
    `;

    assetEntries.appendChild(entry);

    buildAutocomplete({
      inputId:`asset_search_${eid}`,
      panelId:`asset_panel_${eid}`,
      toggleId:`asset_toggle_${eid}`,
      data:assetLines,
      onPick:(line)=>updateAssetPhotoIn(entry, line)
    });

    const entryAssetInput = entry.querySelector(`#asset_search_${eid}`);
    entryAssetInput.addEventListener('input', () => {
      const v = entryAssetInput.value.trim().toLowerCase();
      const exact = assetLines.find(d => d.toLowerCase() === v);
      updateAssetPhotoIn(entry, exact || '');
    });
    entryAssetInput.addEventListener('change', () => {
      const v = entryAssetInput.value.trim().toLowerCase();
      const exact = assetLines.find(d => d.toLowerCase() === v);
      updateAssetPhotoIn(entry, exact || '');
    });

    wireEntryDynamicBehaviours(entry);
  }

  /* ---------- Validation & helpers ---------- */
  function ensureWoOrAlert() {
    const woEl = document.getElementById('wo_number');
    const wo = (woEl.value || '').trim();
    if (!wo) { alert('Please, enter Assigned WO#.'); woEl.focus(); return null; }
    return wo;
  }

  function validateMandatoryQuestions() {
    const firstEntryAsset = document.querySelector('.asset-entry input[id^="asset_search_"]');
    if (!firstEntryAsset || !firstEntryAsset.value.trim()) {
      alert('Please select the Equipment / Asset ID for the first entry.');
      firstEntryAsset?.focus(); return false;
    }

    for (let i = 1; i <= 7; i++) {
      const radios = document.querySelectorAll(`input[name^="q${i}_"]`);
      const anyChecked = Array.from(radios).some(r => r.checked);
      if (!anyChecked) {
        alert(`Please answer question ${i} before submitting.`);
        radios[0]?.scrollIntoView({ behavior: "smooth", block: "center" });
        return false;
      }
    }
    const amt = document.querySelector(".amt_value");
    if (!amt || !amt.value.trim()) {
      alert("Please fill in question 1B (Amount of lubricant inserted/filled).");
      amt?.scrollIntoView({ behavior: "smooth", block: "center" }); amt?.focus();
      return false;
    }
    const comments = document.querySelector(".entry-comments");
    if (!comments || !comments.value.trim()) {
      alert("Please provide a comment for question 8 (Additional comments).");
      comments?.scrollIntoView({ behavior: "smooth", block: "center" }); comments?.focus();
      return false;
    }

    const execName = document.getElementById('exec_name');
    const execDate = document.getElementById('exec_date');
    const execTime = document.getElementById('exec_time');
    if (!execName?.value.trim()) { alert('Please enter the Inspector / Technician name.'); execName?.focus(); return false; }
    if (!execDate?.value) { alert('Please enter the execution date.'); execDate?.focus(); return false; }
    if (!execTime?.value) { alert('Please enter the execution time.'); execTime?.focus(); return false; }

    return true;
  }

  function buildStatusAndBody() {
    const getFollowupComment = (qNum) => {
      const textarea = document.querySelector(`section.q[data-q="${qNum}"] .followup textarea`);
      const comment = textarea ? textarea.value.trim() : '';
      return comment || 'No specific comment provided.';
    };
    const q = n => {
      const r = document.querySelector(`input[name^="q${n}_"]:checked`);
      return r?.value || '';
    };

    const redItems = [];
    if (q(1) === 'No')  redItems.push(`Lubrication point issues during the Lubrication Process.\nComments: ${getFollowupComment('1')}`);
    if (q(2) === 'Yes') redItems.push(`Inconsistency in the volume added to the lubrication point.\nComments: ${getFollowupComment('2')}`);
    if (q(3) === 'No')  redItems.push(`Impact on Condition of the lubrication related components.\nComments: ${getFollowupComment('3')}`);
    if (q(4) === 'Yes') redItems.push(`Damage or leakage identified in the lubricated point.\nComments: ${getFollowupComment('4')}`);
    if (q(5) === 'Yes') redItems.push(`Lubricant consistency out of spec.\nComments: ${getFollowupComment('5')}`);
    if (q(6) === 'No')  redItems.push(`Issues with the lubrication point Identification found.\nComments: ${getFollowupComment('6')}`);
    if (q(7) === 'No')  redItems.push(`Safety related issues identified during lubrication.\nComments: ${getFollowupComment('7')}`);

    const isGreen = redItems.length === 0;

    const metaInfo = [
      `Business Unit: ${document.getElementById('business_unit').value}`,
      `Department: ${document.getElementById('department').value}`,
      `WO#: ${document.getElementById('wo_number').value || '‚Äî'}`,
      `Route: ${document.getElementById('route_search').value || '‚Äî'}`,
      `Asset: ${document.querySelector('.asset-entry input[id^="asset_search_"]')?.value || '‚Äî'}`,
      `Inspector: ${document.getElementById('exec_name')?.value || '‚Äî'}`,
      `Execution Date: ${document.getElementById('exec_date')?.value || '‚Äî'}`,
      `Execution Time: ${document.getElementById('exec_time')?.value || '‚Äî'}`
    ];

    let bodyLines = [];
    if (isGreen) {
      bodyLines.push('QA/QC Performed - Green STATUS üü¢\n');
      bodyLines.push(...metaInfo);
      bodyLines.push('\nNo issues found.');
    } else {
      bodyLines.push('QA/QC Performed - RED STATUS üî¥\n');
      bodyLines.push('Highlights that can better looked at the PDF report attached\n');
      bodyLines.push(...metaInfo);
      bodyLines.push('\n' + '# ------ # ------ # ------ # ------ # ------ #'.replace(/ /g, ' '));
      bodyLines.push(redItems.join('\n\n')); 
    }
    return { isGreen, bodyText: bodyLines.join('\n') };
  }

  function syncInputValuesToAttributes() {
    const inputs = document.querySelectorAll(
      '#captureArea input[type="text"], #captureArea input[type="date"], #captureArea input[type="time"], #captureArea textarea, #captureArea input:not([type])'
    );
    inputs.forEach(el => { el.setAttribute('value', el.value); });
  }

  function buildSubject() {
    const wo = document.getElementById('wo_number').value || 'TIN-XXXXX';
    const { isGreen } = buildStatusAndBody();
    const statusText = isGreen ? 'Green Status üü¢' : 'Red Status üî¥';
    return `QA/QC Execution Report - WO# ${wo} - ${statusText}`;
  }

  /* ---- Printable radios ---- */
  let _radioSnapshots = [];
  function makeRadiosPrintable(){
    _radioSnapshots = [];
    const containers = document.querySelectorAll('.q .opts, .inline-opts');
    containers.forEach(c => {
      const html = c.innerHTML;
      const radios = Array.from(c.querySelectorAll('input[type="radio"]'));
      if (!radios.length) return;
      const parts = radios.map(r => {
        const text = (r.parentNode.textContent || '').trim();
        const cls  = r.checked ? 'rb-mark rb-sel' : 'rb-mark rb-unsel';
        const dot  = r.checked ? '‚óè' : '‚óã';
        return `<span class="${cls}">${dot} ${text}</span>`;
      });
      _radioSnapshots.push([c, html]);
      c.innerHTML = parts.join('');
    });
  }
  function restoreRadios(){ _radioSnapshots.forEach(([n,h])=>{ n.innerHTML=h; }); _radioSnapshots=[]; }

  /* ---- Printable inputs/textarea ---- */
  let _inputSnapshots = [];
  function makeInputsPrintable(){
    _inputSnapshots = [];
    const sel = '#captureArea input[type="text"], #captureArea input[type="date"], #captureArea input[type="time"], #captureArea input[type="number"], #captureArea textarea, #captureArea input:not([type])';
    document.querySelectorAll(sel).forEach(el => {
      let val = (el.value ?? '').toString();
      if (!val.trim()) val = '‚Äî';
      const clone = document.createElement('span');
      clone.className = 'input-print';
      clone.textContent = val;
      const cs = getComputedStyle(el);
      if (cs.display === 'block') clone.style.display = 'block';
      clone.style.width = (el.offsetWidth ? el.offsetWidth + 'px' : '100%');
      _inputSnapshots.push({ el, parent: el.parentNode, next: el.nextSibling, clone });
      el.classList.add('hidden');
      el.parentNode.insertBefore(clone, el.nextSibling);
    });
  }
  function restoreInputs(){
    _inputSnapshots.forEach(({el,parent,next,clone})=>{
      if (clone && clone.parentNode) clone.parentNode.removeChild(clone);
      el.classList.remove('hidden');
      if (el.parentNode !== parent) parent.insertBefore(el,next);
    });
    _inputSnapshots=[];
  }

  function showToast(){
    const t = document.getElementById('toast');
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 2400);
  }

  /* ---------- PDF + Email ---------- */
  function downloadPDF(){
    const toHide = document.querySelectorAll('.ac-panel, .ac-chevron, .entry-controls, .actions');
    toHide.forEach(el => el.classList.add('hidden'));

    makeRadiosPrintable();
    makeInputsPrintable();

    const wo = document.getElementById('wo_number').value || 'TIN-XXXXX';
    const filename = `QAQC_${wo}.pdf`;
    const element = document.getElementById('captureArea');

    const opt = {
      margin:[10,10,10,10],
      filename,
      image:{ type:'jpeg', quality:0.98 },
      html2canvas:{ scale:2, useCORS:true, scrollY:0 },
      jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
    };

    return html2pdf().from(element).set(opt).save().finally(()=>{
      restoreInputs();
      restoreRadios();
      toHide.forEach(el => el.classList.remove('hidden'));
    });
  }

  function submitThenPdf() {
    if (!ensureWoOrAlert()) return;
    if (!validateMandatoryQuestions()) return;
    syncInputValuesToAttributes();

    const subject = buildSubject();
    const { bodyText } = buildStatusAndBody();
    const mailto = `mailto:${encodeURIComponent(RECIPIENT)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;
    window.location.href = mailto;

    setTimeout(() => {
      downloadPDF().then(() => {
        clearForm();
        showToast();
      });
    }, 350);
  }

  function printPdfClicked(){
    if (!ensureWoOrAlert()) return;
    if (!validateMandatoryQuestions()) return;
    syncInputValuesToAttributes();
    downloadPDF();
  }

  function clearForm(){
    ['business_unit','department','wo_number','route_search'].forEach(id=>{
      const el = document.getElementById(id); if (el) el.value = '';
    });
    document.getElementById('formBody').classList.add('hidden');
    document.getElementById('routeGate').classList.remove('hidden');
    assetEntries.innerHTML = '';

    const n = document.getElementById('exec_name');
    const d = document.getElementById('exec_date');
    const t = document.getElementById('exec_time');
    if (n) n.value = '';
    if (d) d.value = '';
    if (t) t.value = '';
  }

  document.getElementById('submitBtn').addEventListener('click', submitThenPdf);
  document.getElementById('printBtn').addEventListener('click', printPdfClicked);
  document.getElementById('clearBtn').addEventListener('click', clearForm);

  (function autofillExec(){
    const d = document.getElementById('exec_date');
    const t = document.getElementById('exec_time');
    const now = new Date();
    if (d && !d.value) d.value = now.toISOString().slice(0,10);
    if (t && !t.value) t.value = now.toTimeString().slice(0,5);
  })();

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js', { scope: './' })
        .catch(err => console.error('SW registration failed:', err));
    });
  }
</script>
</body>
</html>
